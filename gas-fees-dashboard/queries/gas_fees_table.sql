-- Gas Fees Table
-- Table with sums and averages of gas fees and variables related to it's calculation for each block
-- {"type":"TABLE","name":"Gas Fees Table","description":"","options":{"itemsPerPage":10,"columns":[{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_fees_sum","type":"float","displayAs":"number","visible":true,"order":100000,"title":"Gas Fees Sum","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_fees_avg","type":"float","displayAs":"number","visible":true,"order":100001,"title":"Average Gas Fee","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_limit_sum","type":"float","displayAs":"number","visible":true,"order":100002,"title":"Gas Limits Sum","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_limit_avg","type":"float","displayAs":"number","visible":true,"order":100003,"title":"Average Gas Limit","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_fee_cap_sum","type":"float","displayAs":"number","visible":true,"order":100004,"title":"Gas Fee Caps Sum","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_fee_cap_avg","type":"float","displayAs":"number","visible":true,"order":100005,"title":"Average Gas Fee Cap","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_premium_sum","type":"float","displayAs":"number","visible":true,"order":100006,"title":"Gas Premiums Sum","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"gas_premium_avg","type":"float","displayAs":"number","visible":true,"order":100007,"title":"Average Gas Premium","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"avg_base_fee","type":"float","displayAs":"number","visible":true,"order":100008,"title":"Average Base Fee","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"msg_cnt","type":"integer","displayAs":"number","visible":true,"order":100009,"title":"Messages Count","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"numberFormat":"0,0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"epoch","type":"integer","displayAs":"number","visible":true,"order":100010,"title":"Epoch","allowSearch":true,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"dateTimeFormat":"DD/MM/YY HH:mm","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"block_time","type":"datetime","displayAs":"datetime","visible":true,"order":100011,"title":"Block Time","allowSearch":false,"alignContent":"right","allowHTML":true,"highlightLinks":false},{"booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"block_cid","type":"string","displayAs":"string","visible":true,"order":100012,"title":"Block Cid","allowSearch":true,"alignContent":"left","allowHTML":false,"highlightLinks":false}]},"query_id":15}
-- {"options":{"parameterMappings":{},"isHidden":false,"position":{"autoHeight":false,"sizeX":6,"sizeY":13,"maxSizeY":1000,"maxSizeX":6,"minSizeY":1,"minSizeX":2,"col":0,"row":9}},"text":"","width":1,"dashboard_id":1,"visualization_id":54}
SELECT sum(gas_fees) AS gas_fees_sum,
       avg(gas_fees) AS gas_fees_avg,
       sum(gas_limit) AS gas_limit_sum,
       avg(gas_limit) AS gas_limit_avg,
       sum(gas_fee_cap) AS gas_fee_cap_sum,
       avg(gas_fee_cap) AS gas_fee_cap_avg,
       sum(gas_premium) AS gas_premium_sum,
       avg(gas_premium) AS gas_premium_avg,
       avg(parent_base_fee) AS avg_base_fee,
       count(msg_cid) AS msg_cnt,
       epoch,
       block_time,
       block_cid
FROM
  (SELECT least((gas_premium * gas_limit) + (blk.parent_base_fee * gas_used), gas_limit * gas_fee_cap) AS gas_fees,
          gas_limit,
          gas_used,
          gas_fee_cap,
          gas_premium,
          parent_base_fee,
          height AS epoch,
          msg.block_time,
          block_cid,
          msg.cid AS msg_cid
   FROM filecoin.messages AS msg
   LEFT JOIN filecoin.blocks blk ON blk.cid = block_cid
   WHERE gas_used > 0 ) AS g
GROUP BY block_cid,
         epoch,
         block_time